name: Reusable Linter

on:
  workflow_call:
    inputs:
      paths:
        required: false
        type: string
        default: '.'

      clang-format-path:
        required: false
        type: string
        default: '.clang-format'
    secrets:
      REPO_TOKEN:
        required: true
      CI_USER_APP_ID:
        required: true
      CI_USER_PRIVATE_KEY:
        required: true

jobs:
  lint:
    runs-on: self-hosted
    steps:
      - name: Generate token for pulling private repo
        uses: actions/create-github-app-token@v1.5.0
        id: generate_token
        with:
          app-id: ${{ secrets.CI_USER_APP_ID }}
          private-key: ${{ secrets.CI_USER_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate_token.outputs.token }}
          path: main_repo

      - name: Checkout linter repo
        uses: actions/checkout@v4
        with:
          repository: MapIV/map4_github_actions
          token: ${{ steps.generate_token.outputs.token }}
          paht: linter_repo
          ref: test/ci

      - name: Install linter
        run: |
          # Update the package list
          sudo apt-get update
          # Install necessary packages
          sudo apt-get install -y wget xz-utils python3-pip clang-format-18
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1
          sudo update-alternatives --set python /usr/bin/python3
      - name: Run C++ linter
        run: |
          find main_repo -name "*.cpp" -or -name "*.cc" -or -name "*.cu" -or -name "*.h" -or -name "*.hpp" | xargs -n 1 ./linter_repo/run-clang-format.py --config_file main_repo/.clang-format --recursive --color always
